version: 0.2

env:
  parameter-store:
    DOCKER_REGISTRY_USERNAME: /myapp/docker-credentials/username
    DOCKER_REGISTRY_PASSWORD: /myapp/docker-credentials/password

    EC2_HOST: /myapp/ec2/host
    EC2_USER: /myapp/ec2/user
    EC2_SSH_KEY: /myapp/ec2/shh_key

    SONAR_HOST_URL: /myapp/sonar/url
    SONAR_TOKEN: /myapp/sonarqube/codebuild-sonar-token

phases:
  install:
    commands:
      - echo "Preparing SSH key..."
      - echo "$EC2_SSH_KEY" > key.pem
      - chmod 600 key.pem
      - export SSH_CMD="ssh -o StrictHostKeyChecking=no -i key.pem $EC2_USER@$EC2_HOST"

  pre_build:
    commands:
      - echo "Cloning fresh repository in EC2..."
      - |
        $SSH_CMD "sudo rm -rf ~/project && \
                  git clone https://github.com/yojan1226/swiggy-DevOps-Project.git ~/project"

      - echo "Installing NPM dependencies..."
      - |
        $SSH_CMD "cd ~/project/swiggy-project && npm install"

      - echo "Running OWASP dependency-check (clean DB)..."
      - |
        $SSH_CMD "
          mkdir -p ~/dependency-check-reports ~/dependency-check-data && \
          dependency-check --purge --data ~/dependency-check-data || true && \
          dependency-check --updateonly --nvdApiKey '${NVD_API_KEY}' --data ~/dependency-check-data && \
          dependency-check \
            --scan ~/project/swiggy-project \
            --out ~/dependency-check-reports/owasp-report \
            --data ~/dependency-check-data || echo 'OWASP warnings ignored'
        "

      - echo "Running SonarQube Scanner..."
      - |
        $SSH_CMD "cd ~/project/swiggy-project && \
                  sonar-scanner \
                    -Dsonar.projectKey=swiggy-react-app \
                    -Dsonar.sources=. \
                    -Dsonar.host.url=$SONAR_HOST_URL \
                    -Dsonar.login=$SONAR_TOKEN"

  build:
    commands:
      - echo "Running Trivy filesystem scan..."
      - |
        $SSH_CMD "trivy fs --exit-code 1 \
                  --severity HIGH,CRITICAL \
                  ~/project/swiggy-project || true"

      - echo "Building React project..."
      - |
        $SSH_CMD "cd ~/project/swiggy-project && npm run build"

      - echo "Logging into DockerHub from EC2..."
      - |
        $SSH_CMD "echo \"$DOCKER_REGISTRY_PASSWORD\" \
                  | docker login -u \"$DOCKER_REGISTRY_USERNAME\" --password-stdin"

      - echo "Building Docker image on EC2..."
      - |
        $SSH_CMD "cd ~/project/swiggy-project && \
                  DOCKER_USER=$DOCKER_REGISTRY_USERNAME \
                  docker build -t \${DOCKER_USER}/swiggy:latest ."

      - echo "Pushing image to DockerHub..."
      - |
        $SSH_CMD "DOCKER_USER=$DOCKER_REGISTRY_USERNAME \
                  docker push \${DOCKER_USER}/swiggy:latest"



  post_build:
   commands:
     - echo "Scanning pushed image with Trivy..."
     - |
       $SSH_CMD "DOCKER_USER=$DOCKER_REGISTRY_USERNAME \
                trivy image --exit-code 1 \
                --severity HIGH,CRITICAL \
                \${DOCKER_USER}/swiggy:latest || true"

     - echo "Copying OWASP report back to CodeBuild..."
     - |
       scp -o StrictHostKeyChecking=no -i key.pem \
        $EC2_USER@$EC2_HOST:~/dependency-check-reports/* .


artifacts:
  files:
    - appspec.yaml
    - taskdef.json
  